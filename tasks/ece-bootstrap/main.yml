---
- name: Download ece installer
  get_url:
    url: "{{ ece_installer_url }}"
    dest: /home/elastic/elastic-cloud-enterprise.sh
    mode: 0755

- name: check if podman is installed instead of docker
  stat: 
    path: /usr/bin/podman
  register: podman_exec

- name: Docker config
  block:
    - name: Ensure ~/.docker is present
      file:
        path: /home/elastic/.docker/
        state: directory
        owner: elastic

    - name: Copy local docker config
      copy:
        src: "{{ docker_config }}"
        dest: /home/elastic/.docker/config.json
        owner: elastic
      when: docker_config != ""
  when: not podman_exec.stat.exists

- name: Workaround for podman
  block:
    - name: replace docker -H with podman --url in installer
      replace:
        path: /home/elastic/elastic-cloud-enterprise.sh
        regexp: 'docker \-H'
        replace: 'podman-remote --url'
    - name: Make sure /run/user/1001/containers exists
      file:
        path: /run/user/1001/containers/
        state: directory
        owner: elastic
        group: elastic
        mode: 0700
      when: docker_config != ""
    - name: Copy local auth config TODO
      copy:
        src: "{{ docker_config }}"
        dest: /run/user/1001/containers/auth.json
        owner: elastic
      when: docker_config != ""
    - name: set socket for docker or podman service
      lineinfile:
        path: /etc/environment
        line: "{{ item }}"
      with_items:
        - "DOCKER_HOST={{ podman_socket }}"
  when: podman_exec.stat.exists

- name: Check if an installation or upgrade should be performed
  shell: docker ps -a -f name=frc-runners-runner --format {%raw%}"{{.Image}}"{%endraw%}
  register: existing_runner

- name: Create memory settings
  set_fact:
    memory_settings: ' {"runner":{"xms":"{{memory.runner}}","xmx":"{{memory.runner}}"},"proxy":{"xms":"{{memory.proxy}}","xmx":"{{memory.proxy}}"},"zookeeper":{"xms":"{{memory.zookeeper}}","xmx":"{{memory.zookeeper}}"},"director":{"xms":"{{memory.director}}","xmx":"{{memory.director}}"},"constructor":{"xms":"{{memory.constructor}}","xmx":"{{memory.constructor}}"},"admin-console":{"xms":"{{memory.adminconsole}}","xmx":"{{memory.adminconsole}}"}}'

- name: Install Elastic Cloud Enterprise
  block:
    - include_tasks: primary/main.yml
      when: ece_primary is defined and ece_primary

    - include_tasks: secondary/main.yml
      when: ece_primary is undefined or not ece_primary

    - debug:
        msg: "Adminconsole is reachable at: https://{{ primary_hostname }}:12443"
    - debug:
        msg: "Adminconsole password is: {{ adminconsole_root_password }}"
  when: existing_runner.stdout == ""

- include_tasks: upgrade.yml
  when: existing_runner.stdout != ""
